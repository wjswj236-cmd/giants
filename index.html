<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>読売巨人軍 選手顔写真仕分けトレーニング</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* カスタムアニメーション設定 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        
        /* スクロールバーのカスタマイズ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // --- 設定: Google Apps ScriptのWebアプリURL ---
        // 手順:
        // 1. GASコードを修正し、「新しいデプロイ」または「デプロイの管理>新バージョン」で更新する
        // 2. アクセス設定が「自分」「全員」になっていることを確認する
        // 3. 発行されたURLを下の引用符の中に貼り付ける
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxI-DFXifx7rHl8edlnSaLpGPBVo4kw1i87-5eKzisuZh0eLU8A0waMJr8xq1XWy-l2/exec'; 

        // --- データ定義 ---
        const PLAYERS_DATA = [
            { id: 1, name: '阿部 慎之助', position: '監督', number: '83', imageUrl: 'https://prod-giants-site.imagewave.pictures/2sBggzpWpHFgyCZ8VV3r4L?width=828' },
            { id: 2, name: '二岡 智宏', position: 'ヘッド兼打撃チーフコーチ', number: '76', imageUrl: 'https://prod-giants-site.imagewave.pictures/E8NPU9pa7kAxRXgCk8QbE5?width=828' },
            { id: 3, name: '戸郷 翔征', position: '投手', number: '20', imageUrl: 'https://prod-giants-site.imagewave.pictures/U4WPZ6x3KjRzuakHPaKc8Y?width=828' },
            { id: 4, name: '大勢', position: '投手', number: '15', imageUrl: 'https://prod-giants-site.imagewave.pictures/WgbAHKjPfWrff6AJxnX2EJ?width=384' },
            { id: 5, name: '大城 卓三', position: '捕手', number: '24', imageUrl: 'https://prod-giants-site.imagewave.pictures/S7bjtCuRDKXbCNubd6QmJ9?width=1920' },
            { id: 6, name: '岸田 行倫', position: '捕手', number: '27', imageUrl: 'https://prod-giants-site.imagewave.pictures/obZGo3NAiKMxbfgMY7ZQoJ?width=1920' },
            { id: 7, name: '岡本 和真', position: '内野手', number: '25', imageUrl: 'https://prod-giants-site.imagewave.pictures/DgagiB5oVDvwsGSCfcvjGR?width=3840' },
            { id: 8, name: '坂本 勇人', position: '内野手', number: '6', imageUrl: 'https://prod-giants-site.imagewave.pictures/BT34z7RtBvrRrMDQaGYZT9?width=3840' },
            { id: 9, name: '吉川 尚輝', position: '内野手', number: '2', imageUrl: 'https://prod-giants-site.imagewave.pictures/StvCfnoJ6NcStZPnRhyrYo?width=828' },
            { id: 10, name: '門脇 誠', position: '内野手', number: '35', imageUrl: 'https://prod-giants-site.imagewave.pictures/xwYqmb7eU5k8NsngZeiVxG?width=828' },
            { id: 11, name: '丸 佳浩', position: '外野手', number: '8', imageUrl: 'https://prod-giants-site.imagewave.pictures/45B86NvMi9hjZb4YEXHG6K?width=828' },
            { id: 12, name: '長野 久義', position: '外野手', number: '7', imageUrl: 'https://prod-giants-site.imagewave.pictures/KNfifqZVpFjwVnRyabTeYV?width=828' },
            { id: 13, name: 'リチャード', position: '内野手', number: '52', imageUrl: 'https://prod-giants-site.imagewave.pictures/hqySEbnDPPkfxBdt3SFF6J?width=828' },
            { id: 14, name: '西舘 勇陽', position: '投手', number: '17', imageUrl: 'https://prod-giants-site.imagewave.pictures/AW2GhCQqA6uEXhJpRog2C?width=828' },
            { id: 15, name: '山﨑 伊織', position: '投手', number: '19', imageUrl: 'https://prod-giants-site.imagewave.pictures/fyqiQHGtdzug9mJnMKxwVK?width=828' },
        ];

        // --- アイコンコンポーネント (Lucide代替) ---
        const Icon = ({ children, className, size = 24 }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} height={size} 
                viewBox="0 0 24 24" 
                fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Trophy = (props) => <Icon {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></Icon>;
        const XCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const User = (props) => <Icon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const Send = (props) => <Icon {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12"/></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;

        // --- メインアプリケーション ---
        const { useState, useEffect, useMemo } = React;

        function App() {
            const [appState, setAppState] = useState('start'); // 'start' | 'playing' | 'finished'
            const [workerName, setWorkerName] = useState('');
            
            const [quizQueue, setQuizQueue] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selectedName, setSelectedName] = useState('');
            const [quizStep, setQuizStep] = useState('waiting'); // 'waiting' | 'answered'
            const [isCorrect, setIsCorrect] = useState(false);
            const [score, setScore] = useState(0);
            const [imageError, setImageError] = useState(false);

            // 送信関連
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitStatus, setSubmitStatus] = useState(null); // 'success' | 'error'

            const startGame = () => {
                if (!workerName.trim()) return;
                const shuffled = [...PLAYERS_DATA].sort(() => 0.5 - Math.random());
                setQuizQueue(shuffled);
                setCurrentIndex(0);
                setScore(0);
                setQuizStep('waiting');
                setSelectedName('');
                setImageError(false);
                setAppState('playing');
            };

            const restartGame = () => {
                setAppState('start');
                setSubmitStatus(null);
                setIsSubmitting(false);
            };

            const currentQuestion = quizQueue[currentIndex];

            const nameOptions = useMemo(() => {
                return [...PLAYERS_DATA]
                    .map(p => p.name)
                    .sort((a, b) => a.localeCompare(b, 'ja'));
            }, []);

            const handleAnswer = () => {
                if (!selectedName) return;
                const correct = selectedName === currentQuestion.name;
                setIsCorrect(correct);
                if (correct) setScore(s => s + 1);
                setQuizStep('answered');
            };

            const handleNext = () => {
                if (currentIndex >= quizQueue.length - 1) {
                    finishGame();
                } else {
                    setCurrentIndex(prev => prev + 1);
                    setSelectedName('');
                    setQuizStep('waiting');
                    setImageError(false);
                }
            };

            const finishGame = async () => {
                setAppState('finished');
                await sendDataToSheet(score + (isCorrect ? 0 : 0)); 
            };

            const sendDataToSheet = async (finalScore) => {
                // URLが正しく設定されているかチェック
                if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('script.google.com/macros/s/AKfycbx...')) {
                    alert("【設定エラー】\nGASのURLが設定されていないか、サンプルのままです。\nコード内の GOOGLE_SCRIPT_URL を書き換えてください。");
                    setSubmitStatus('error');
                    return;
                }

                setIsSubmitting(true);
                try {
                    // 確実に送れるよう URLSearchParams (x-www-form-urlencoded) を使用
                    const params = new URLSearchParams();
                    params.append('date', new Date().toLocaleString());
                    params.append('name', workerName);
                    params.append('result', `${finalScore}/${quizQueue.length}`);

                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: params.toString(),
                    });
                    
                    // no-corsのため成功判定はできませんが、完了とみなします
                    setSubmitStatus('success');
                } catch (error) {
                    console.error('送信エラー', error);
                    setSubmitStatus('error');
                } finally {
                    setIsSubmitting(false);
                }
            };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (appState !== 'playing') return;
                    if (e.key === 'Enter') {
                        if (quizStep === 'waiting' && selectedName) handleAnswer();
                        else if (quizStep === 'answered') handleNext();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [appState, quizStep, selectedName]);

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="max-w-5xl w-full bg-white rounded-xl shadow-2xl overflow-hidden border-t-8 border-[#f97709] flex flex-col min-h-[600px]">
                        
                        <header className="bg-black text-white p-4 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold tracking-wider">選手顔写真仕分けトレーニング</h1>
                                <p className="text-xs text-gray-400">Yomiuri Giants Player Quiz</p>
                            </div>
                            {appState !== 'start' && (
                                <div className="text-sm text-gray-300">
                                    担当: <span className="font-bold text-white">{workerName}</span>
                                </div>
                            )}
                        </header>

                        <div className="flex-1 flex flex-col md:flex-row relative">
                            
                            {/* スタート画面 */}
                            {appState === 'start' && (
                                <div className="w-full h-full absolute inset-0 z-10 bg-white flex flex-col items-center justify-center p-8 animate-fade-in">
                                    <div className="max-w-md w-full text-center space-y-6">
                                        <div className="bg-[#f97709]/10 p-4 rounded-full inline-block mb-2">
                                            <User className="text-[#f97709]" size={48} />
                                        </div>
                                        <h2 className="text-2xl font-bold">業務を開始します</h2>
                                        <p className="text-gray-600">
                                            記録のため、作業者名を入力してください。<br/>
                                            全問終了後、自動的に結果が送信されます。
                                        </p>
                                        <div className="text-left">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">氏名</label>
                                            <input
                                                type="text"
                                                value={workerName}
                                                onChange={(e) => setWorkerName(e.target.value)}
                                                placeholder="例: 巨人 太郎"
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#f97709] focus:border-transparent outline-none"
                                                onKeyDown={(e) => e.key === 'Enter' && startGame()}
                                            />
                                        </div>
                                        <button 
                                            onClick={startGame}
                                            disabled={!workerName.trim()}
                                            className={`w-full py-4 rounded-lg font-bold text-white text-lg transition-all
                                                ${workerName.trim() 
                                                    ? 'bg-[#f97709] hover:bg-[#d66506] shadow-lg transform hover:-translate-y-1' 
                                                    : 'bg-gray-300 cursor-not-allowed'}`}
                                        >
                                            トレーニング開始
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* 完了画面 */}
                            {appState === 'finished' && (
                                <div className="w-full h-full absolute inset-0 z-10 bg-white flex flex-col items-center justify-center p-8 animate-fade-in text-center">
                                    <Trophy className="text-[#f97709] mb-6" size={96} />
                                    <h2 className="text-3xl font-bold mb-2">業務完了</h2>
                                    <p className="text-gray-500 mb-8">お疲れ様でした。</p>
                                    
                                    <div className="bg-gray-50 rounded-xl p-8 mb-8 border border-gray-200 w-full max-w-md">
                                        <div className="text-sm text-gray-500 mb-2">今回の成績</div>
                                        <div className="text-5xl font-bold text-gray-900 mb-2">
                                            {score} <span className="text-2xl font-normal text-gray-400">/ {quizQueue.length}</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-2.5 mt-4 overflow-hidden">
                                            <div 
                                                className="bg-[#f97709] h-2.5 rounded-full" 
                                                style={{ width: `${(score / quizQueue.length) * 100}%` }}
                                            ></div>
                                        </div>
                                    </div>

                                    <div className="mb-8 min-h-[30px]">
                                        {GOOGLE_SCRIPT_URL ? (
                                            <>
                                                {isSubmitting && (
                                                    <span className="text-gray-500 flex items-center justify-center gap-2">
                                                        <span className="animate-spin text-gray-400">●</span> データを送信中...
                                                    </span>
                                                )}
                                                {!isSubmitting && submitStatus === 'success' && (
                                                    <div className="flex flex-col items-center">
                                                        <span className="text-green-600 flex items-center justify-center gap-2 font-bold">
                                                            <Check size={20} /> 記録を保存しました
                                                        </span>
                                                        <p className="text-xs text-gray-400 mt-1">※反映されない場合はGASの「デプロイ設定(全員許可)」を確認してください</p>
                                                    </div>
                                                )}
                                                {!isSubmitting && submitStatus === 'error' && (
                                                    <span className="text-red-500 flex items-center justify-center gap-2">
                                                        <AlertCircle size={20} /> 設定エラー: GAS URLを確認してください
                                                    </span>
                                                )}
                                            </>
                                        ) : (
                                            <p className="text-xs text-red-500 font-bold">
                                                ※ GASのURLが設定されていません。コードを修正してください。
                                            </p>
                                        )}
                                    </div>

                                    <button 
                                        onClick={restartGame}
                                        className="bg-black hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-lg flex items-center gap-2 transition-colors"
                                    >
                                        <RotateCcw size={18} />
                                        次の作業者が開始する
                                    </button>
                                </div>
                            )}

                            {/* クイズ画面 */}
                            {appState === 'playing' && currentQuestion && (
                                <>
                                    <div className="w-full md:w-1/2 bg-gray-900 flex items-center justify-center p-4 relative overflow-hidden">
                                        <div className="relative w-full max-w-sm aspect-[3/4] md:h-full md:w-auto md:aspect-auto rounded-lg overflow-hidden shadow-2xl border-4 border-white/10">
                                            {imageError ? (
                                                <div className="w-full h-full flex flex-col items-center justify-center text-gray-400 bg-gray-800">
                                                    <User size={64} className="opacity-50 mb-2" />
                                                    <span>No Image</span>
                                                </div>
                                            ) : (
                                                <img 
                                                    src={currentQuestion.imageUrl} 
                                                    alt="Player" 
                                                    className="w-full h-full object-cover"
                                                    onError={() => setImageError(true)}
                                                />
                                            )}
                                            
                                            {quizStep === 'answered' && (
                                                <div className={`absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fade-in`}>
                                                    {isCorrect ? (
                                                        <div className="bg-white/90 p-6 rounded-full shadow-lg transform scale-125">
                                                            <CheckCircle className="text-green-600" size={80} />
                                                        </div>
                                                    ) : (
                                                        <div className="bg-white/90 p-6 rounded-full shadow-lg transform scale-125">
                                                            <XCircle className="text-red-600" size={80} />
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="w-full md:w-1/2 flex flex-col p-6 md:p-10 bg-white justify-center">
                                        
                                        <div className="flex justify-between items-end mb-6 border-b pb-2">
                                            <div className="text-4xl font-black text-gray-200">
                                                {String(currentIndex + 1).padStart(2, '0')}
                                            </div>
                                            <div className="text-sm font-medium text-gray-400">
                                                残り {quizQueue.length - (currentIndex + 1)} 人
                                            </div>
                                        </div>

                                        <div className="flex-1 flex flex-col justify-center space-y-6">
                                            {quizStep === 'waiting' ? (
                                                <div className="space-y-6 animate-slide-up">
                                                    <div>
                                                        <label className="block text-sm font-bold text-gray-500 mb-2 uppercase tracking-wide">
                                                            Who is this player?
                                                        </label>
                                                        <select 
                                                            value={selectedName}
                                                            onChange={(e) => setSelectedName(e.target.value)}
                                                            size={nameOptions.length > 10 ? 10 : 5}
                                                            className="block w-full p-2 text-lg border-2 border-gray-200 rounded-lg focus:outline-none focus:border-[#f97709] focus:ring-4 focus:ring-[#f97709]/10 bg-gray-50 transition-all custom-scrollbar"
                                                            style={{ maxHeight: '300px' }}
                                                        >
                                                            {nameOptions.map(name => (
                                                                <option key={name} value={name} className="p-2 cursor-pointer hover:bg-orange-50 rounded">
                                                                    {name}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        <p className="text-xs text-gray-400 mt-2 text-right">
                                                            ※ Enterキーで決定
                                                        </p>
                                                    </div>

                                                    <button 
                                                        onClick={handleAnswer}
                                                        disabled={!selectedName}
                                                        className={`w-full py-4 px-6 rounded-lg font-bold text-white text-lg shadow-lg flex items-center justify-center gap-2 transition-all
                                                            ${selectedName 
                                                                ? 'bg-[#f97709] hover:bg-[#d66506] hover:scale-[1.02]' 
                                                                : 'bg-gray-300 cursor-not-allowed'}`}
                                                    >
                                                        回答を確認 <Send size={18} />
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="space-y-6 animate-slide-up">
                                                    <div>
                                                        <div className="text-sm text-gray-400 mb-1">正解は...</div>
                                                        <div className="text-3xl font-bold text-gray-800 border-l-4 border-[#f97709] pl-4 py-2 bg-gray-50 rounded-r-lg">
                                                            {currentQuestion.name}
                                                        </div>
                                                        <div className="mt-2 text-gray-600 pl-5 flex gap-4">
                                                            <span className="bg-gray-200 px-2 py-0.5 rounded text-sm font-bold">
                                                                {currentQuestion.position}
                                                            </span>
                                                            <span className="font-mono text-gray-500">
                                                                #{currentQuestion.number}
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <div className={`p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-50 border-green-500 text-green-700' : 'bg-red-50 border-red-500 text-red-700'}`}>
                                                        {isCorrect 
                                                            ? 'Excellent! 正解です。' 
                                                            : `残念... あなたの回答: ${selectedName}`}
                                                    </div>

                                                    <button 
                                                        onClick={handleNext}
                                                        autoFocus
                                                        className="w-full bg-black hover:bg-gray-800 text-white py-4 rounded-lg font-bold text-lg shadow-lg transition-transform hover:scale-[1.02] flex items-center justify-center gap-2"
                                                    >
                                                        {currentIndex >= quizQueue.length - 1 ? '結果を見る' : '次の問題へ'}
                                                        <Check size={18} />
                                                    </button>
                                                    <p className="text-xs text-gray-400 text-center">Enterキーで次へ</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>